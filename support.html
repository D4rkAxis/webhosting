<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOB CRM Portal</title>
<style>
:root {
    --primary-blue: #1a56db;
    --hover-blue: #1e429f;
    --bg-gray: #f3f4f6;
    --border-color: #d1d5db;
    --text-dark: #111827;
    --text-light: #6b7280;
    --error-red: #c81e1e;
    --success-green: #057a55;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: var(--bg-gray);
    color: var(--text-dark);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}
.container {
    background: white;
    border-radius: 8px;
    padding: 30px;
    width: 100%;
    max-width: 550px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    border: 1px solid #e5e7eb;
}
.tabs {
    display: flex;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border-color);
}
.tab-btn {
    flex: 1;
    padding: 14px;
    background: none;
    border: none;
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.2s;
}
.tab-btn.active {
    color: var(--primary-blue);
    border-bottom: 3px solid var(--primary-blue);
}
.tab-btn:hover:not(.active) {
    color: var(--text-dark);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
h1 {
    text-align: left;
    margin-bottom: 8px;
    font-size: 1.5rem;
    color: var(--text-dark);
    font-weight: 700;
    border-bottom: 2px solid var(--primary-blue);
    display: inline-block;
    padding-bottom: 5px;
}
p.subtitle {
    color: var(--text-light);
    font-size: 0.9rem;
    margin-bottom: 30px;
}
.form-group { margin-bottom: 24px; }
label {
    display: block;
    margin-bottom: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-dark);
}
input, textarea, select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: white;
    color: var(--text-dark);
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
}
input:focus, textarea:focus, select:focus {
    border-color: var(--primary-blue);
    outline: none;
    box-shadow: 0 0 0 3px rgba(26,86,219,0.1);
}
textarea { resize: vertical; min-height: 100px; }
.error-field { border: 1px solid var(--error-red) !important; }
.buttons { display: flex; gap: 12px; margin-top: 10px; }
button {
    flex: 1;
    padding: 12px;
    border: 1px solid transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
#send-btn, #check-btn { background: var(--primary-blue); color: white; }
#send-btn:hover, #check-btn:hover { background: var(--hover-blue); }
#send-btn:disabled, #check-btn:disabled { background: #9ca3af; cursor: not-allowed; }
#send-btn.loading, #check-btn.loading { cursor: wait; opacity: 0.9; }
.spinner {
    display: none;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,0.5);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}
#send-btn.loading .spinner, #check-btn.loading .spinner { display: inline-block; }
@keyframes spin { to { transform: rotate(360deg); } }
#clear-btn { background: white; color: var(--text-dark); border: 1px solid var(--border-color); }
#clear-btn:hover { background: #f9fafb; border-color: #9ca3af; }
.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--text-dark);
    color: white;
    padding: 12px 24px;
    border-radius: 6px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    z-index: 1000;
    font-size: 14px;
    display: none;
    animation: slideUp 0.3s ease-out;
}
.toast.error { background: var(--error-red); }
.toast.success { background: var(--success-green); }
@keyframes slideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.response-box {
    margin-top: 30px;
    padding: 20px;
    background: #f9fafb;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    white-space: pre-wrap;
    font-size: 14px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
}
.history { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
.history h3 {
    font-size: 0.9rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 15px;
}
#history-list { max-height: 150px; overflow-y: auto; }
.history-item {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 12px;
    color: var(--text-dark);
    display: flex;
    justify-content: space-between;
}
@media (max-width: 600px) {
    .container { padding: 20px; }
    .tabs { flex-direction: column; }
    .tab-btn { text-align: center; padding: 16px; border-bottom: 1px solid var(--border-color); }
    .tab-btn.active { border-bottom: 4px solid var(--primary-blue); }
}
</style>
</head>
<body>
<div class="container">
    <div class="tabs">
        <button class="tab-btn active" data-tab="check">Check Status</button>
        <button class="tab-btn" data-tab="close">Close Job</button>
    </div>

    <div id="check-tab" class="tab-content active">
        <h1>Check ONU Status</h1>
        <p class="subtitle">Enter Ticket ID to see current online status, signal strength, and recommendation before closing.</p>
        <form id="check-form">
            <div class="form-group">
                <label for="check-ticket-id">Ticket ID</label>
                <input type="text" id="check-ticket-id" placeholder="e.g. FOB12345" required>
            </div>
            <div class="buttons">
                <button type="submit" id="check-btn">
                    <span class="spinner"></span>
                    <span id="check-btn-text">Check Status</span>
                </button>
            </div>
        </form>
        <div id="check-response" class="response-box"></div>
    </div>

    <div id="close-tab" class="tab-content">
        <h1>Close Ticket Job</h1>
        <p class="subtitle">Submit closure details after checking status.</p>
        <form id="bot-form">
            <div class="form-group">
                <label for="area-select">Operational Area</label>
                <select id="area-select" required>
                    <option value="" disabled selected>Select Area</option>
                    <!-- options remain the same -->
                    <option value="Area 6S YABA">Area 6S YABA</option>
                    <option value="AREA 2E OREGUN">AREA 2E OREGUN</option>
                    <option value="AREA 3S GBAGADA">AREA 3S GBAGADA</option>
                    <option value="AREA 4 AREPO">AREA 4 AREPO</option>
                    <option value="AREA 2S KETU">AREA 2S KETU</option>
                    <option value="Area 6N SURULERE">Area 6N SURULERE</option>
                    <option value="Area 1N Ikeja Opebi Allen">Area 1N Ikeja Opebi Allen</option>
                    <option value="Area 3N Anthony Mende">Area 3N Anthony Mende</option>
                    <option value="Area 1S Ikeja GRAOgba">Area 1S Ikeja GRAOgba</option>
                    <option value="Area 2N Ojodu">Area 2N Ojodu</option>
                    <option value="Area 5 Festac">Area 5 Festac</option>
                    <option value="Area 3W IllupejuAjao">Area 3W IllupejuAjao</option>
                    <option value="Area 15 Alimosho">Area 15 Alimosho</option>
                    <option value="Area 11">Area 11</option>
                    <option value="AREA 7 (ONIRU)">AREA 7 (ONIRU)</option>
                    <option value="AREA 8 (VI)">AREA 8 (VI)</option>
                    <option value="Area 9N (Lekki Phase1)">Area 9N (Lekki Phase1)</option>
                    <option value="Area 10N (Agungi)">Area 10N (Agungi)</option>
                    <option value="Area 10S (Agungi)">Area 10S (Agungi)</option>
                    <option value="Area 10E (Agungi Ologolo Igboefon)">Area 10E (Agungi Ologolo Igboefon)</option>
                    <option value="Area 9S (Lekki /Ikate)">Area 9S (Lekki /Ikate)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="operator-name">Operator Name</label>
                <input type="text" id="operator-name" placeholder="Enter Name" required>
            </div>
            <div class="form-group">
                <label for="ticket-id">Ticket ID</label>
                <input type="text" id="ticket-id" placeholder="e.g. FOB12345" required>
            </div>
            <div class="form-group">
                <label for="op-power">OP (dBm)</label>
                <input type="text" id="op-power" placeholder="e.g. -18.50" required>
            </div>
            <div class="form-group">
                <label for="rca">Root Cause Analysis (RCA)</label>
                <textarea id="rca" placeholder="Provide technical details regarding the root cause..." required></textarea>
            </div>
            <div class="form-group">
                <label for="modem-required">Modem Required</label>
                <select id="modem-required" required>
                    <option value="" disabled selected>Select status</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div class="form-group">
                <label for="job-status">Job Status</label>
                <select id="job-status" required>
                    <option value="" disabled selected>Select Status</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Unresolved">Unresolved</option>
                </select>
            </div>
            <div class="buttons">
                <button type="button" id="clear-btn">Clear Form</button>
                <button type="submit" id="send-btn">
                    <span class="spinner"></span>
                    <span id="btn-text">Submit Job</span>
                </button>
            </div>
        </form>
        <div class="history">
            <h3>Recent Activity (This Browser)</h3>
            <div id="history-list"></div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
// CONFIG
const RELAY_BOT_TOKEN = '8588686796:AAEseHMdM_zr_9MMwg2Bt3BGh2viKtryDTc';
const CHANNEL_ID = '-1003563647186';
const TG_API = 'https://api.telegram.org/bot';
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwWuX_XZ9VRlYhVBAb8vcXchla9-FhVaihpcVqVGAJo-4R5G1QZv9ukNJoyj-__LmNO/exec';

async function sendToGoogleSheet(formData) {
    try {
        await fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
    } catch (err) {
        console.error("Error sending to sheet:", err);
    }
}

function showToast(message, type = '') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 5000);
}

// TAB SWITCHING
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
    });
});

// CHECK STATUS TAB
const checkForm = document.getElementById('check-form');
const checkInput = document.getElementById('check-ticket-id');
const checkBtn = document.getElementById('check-btn');
const checkResponse = document.getElementById('check-response');

async function pollForStatus(ticketId, startTime) {
    const POLL_INTERVAL = 3000;
    const TIMEOUT = 120000; // 2 minutes
    let elapsed = 0;
    let nextOffset = null;
    let collected = '';

    checkResponse.textContent = 'Request sent — waiting for response...\n\n';
    checkResponse.style.display = 'block';

    while (elapsed < TIMEOUT) {
        try {
            let url = `${TG_API}${RELAY_BOT_TOKEN}/getUpdates?allowed_updates=${encodeURIComponent('["channel_post"]')}`;
            if (nextOffset) url += `&offset=${nextOffset}`;
            const res = await fetch(url);
            const data = await res.json();

            if (data.ok && data.result.length > 0) {
                nextOffset = data.result[data.result.length - 1].update_id + 1;
                for (const update of data.result) {
                    const msg = update.channel_post;
                    if (msg && msg.text && msg.date >= Math.floor(startTime / 1000)) {
                        if (msg.text.toLowerCase().includes(ticketId.toLowerCase())) {
                            collected += msg.text + '\n\n';
                            checkResponse.textContent = collected;
                            checkResponse.scrollTop = checkResponse.scrollHeight;
                        }
                    }
                }
            }
        } catch (e) {
            console.error("Polling error:", e);
        }
        await new Promise(r => setTimeout(r, POLL_INTERVAL));
        elapsed += POLL_INTERVAL;
    }

    if (!collected.trim()) {
        checkResponse.textContent += '\nTimeout: No response from bot. Try again or check manually.';
    } else {
        checkResponse.textContent += '\nCheck complete.';
    }
}

checkForm.addEventListener('submit', async e => {
    e.preventDefault();
    const ticketId = checkInput.value.trim().toUpperCase();
    if (!ticketId) {
        showToast('Please enter a Ticket ID', 'error');
        return;
    }

    checkBtn.disabled = true;
    checkBtn.classList.add('loading');
    document.getElementById('check-btn-text').textContent = 'Checking...';

    try {
        const command = `/tik ${ticketId}`;
        const sendRes = await fetch(`${TG_API}${RELAY_BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: CHANNEL_ID, text: command })
        });

        const sendData = await sendRes.json();
        if (!sendData.ok) throw new Error(sendData.description || 'Failed to send command');

        const startTime = Date.now();
        await pollForStatus(ticketId, startTime);

        showToast('Status check complete', 'success');
    } catch (err) {
        checkResponse.style.display = 'block';
        checkResponse.textContent = `Error: ${err.message}`;
        showToast('Error sending request', 'error');
    } finally {
        checkBtn.disabled = false;
        checkBtn.classList.remove('loading');
        document.getElementById('check-btn-text').textContent = 'Check Again';
        checkInput.value = '';
    }
});

// CLOSE JOB TAB (original logic with bug fixes)
const form = document.getElementById('bot-form');
const ticketInput = document.getElementById('ticket-id');
const rcaInput = document.getElementById('rca');
const areaSelect = document.getElementById('area-select');
const modemSelect = document.getElementById('modem-required');
const opNameInput = document.getElementById('operator-name');
const opPowerInput = document.getElementById('op-power');
const statusSelect = document.getElementById('job-status');
const sendBtn = document.getElementById('send-btn');
const clearBtn = document.getElementById('clear-btn');
const historyList = document.getElementById('history-list');

function loadHistory() {
    const history = JSON.parse(localStorage.getItem('fobBotHistory') || '[]');
    historyList.innerHTML = '';
    history.slice(0, 10).forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `<span><strong>${item.ticket}</strong> | ${item.modem}</span><span>${item.time}</span>`;
        historyList.appendChild(div);
    });
}
function saveToHistory(ticket, modem) {
    const history = JSON.parse(localStorage.getItem('fobBotHistory') || '[]');
    history.unshift({ ticket, modem, time: new Date().toLocaleTimeString('en-NG', { hour: '2-digit', minute: '2-digit' }) });
    if (history.length > 50) history.pop();
    localStorage.setItem('fobBotHistory', JSON.stringify(history));
    loadHistory();
}

clearBtn.addEventListener('click', () => {
    form.reset();
    [ticketInput, rcaInput, areaSelect, modemSelect, opNameInput, opPowerInput, statusSelect].forEach(el => el.classList.remove('error-field'));
});

async function pollForResponse(ticketId, startTime) {
    const POLL_INTERVAL = 2000;
    const TIMEOUT = 300000;
    let elapsed = 0;
    let nextOffset = null;

    while (elapsed < TIMEOUT) {
        try {
            const url = `${TG_API}${RELAY_BOT_TOKEN}/getUpdates?allowed_updates=${encodeURIComponent('["channel_post","message"]')}` + (nextOffset ? `&offset=${nextOffset}` : '');
            const res = await fetch(url);
            const data = await res.json();

            if (data.ok && data.result.length > 0) {
                nextOffset = data.result[data.result.length - 1].update_id + 1;
                for (const update of data.result) {
                    const msg = update.channel_post || update.message;
                    if (!msg || !msg.text) continue;

                    if (msg.date >= Math.floor(startTime / 1000) && msg.text.toLowerCase().includes(ticketId.toLowerCase())) {
                        const text = msg.text.toLowerCase();
                        if (text.includes('success') || text.includes('done') || text.includes('completed') || text.includes('resolved')) {
                            return { success: true, message: msg.text };
                        } else if (text.includes('fail') || text.includes('error') || text.includes('invalid') || text.includes('closed') || text.includes('stopped')) {
                            return { success: false, message: msg.text };
                        }
                    }
                }
            }
        } catch (e) { console.error("Polling error:", e); }
        await new Promise(r => setTimeout(r, POLL_INTERVAL));
        elapsed += POLL_INTERVAL;
    }
    throw new Error("Timeout: No response from automation bot.");
}

form.addEventListener('submit', async e => {
    e.preventDefault();

    const ticketId = ticketInput.value.trim();
    const rca = rcaInput.value.trim();
    const area = areaSelect.value;
    const modem = modemSelect.value;
    const opName = opNameInput.value.trim();
    const opPower = opPowerInput.value.trim();
    const status = statusSelect.value;

    let valid = true;
    const fields = [ticketInput, rcaInput, areaSelect, modemSelect, opNameInput, opPowerInput, statusSelect];
    fields.forEach(f => f.classList.remove('error-field'));
    if (!ticketId) { ticketInput.classList.add('error-field'); valid = false; }
    if (rca.length < 5) { rcaInput.classList.add('error-field'); valid = false; }
    if (!modem) { modemSelect.classList.add('error-field'); valid = false; }
    if (!area) { areaSelect.classList.add('error-field'); valid = false; }
    if (!opName) { opNameInput.classList.add('error-field'); valid = false; }
    if (!opPower) { opPowerInput.classList.add('error-field'); valid = false; }
    if (!status) { statusSelect.classList.add('error-field'); valid = false; }

    if (!valid) return showToast('Please fill all fields correctly.', 'error');

    sendToGoogleSheet({
        timestamp: new Date().toISOString(),
        area: area,
        ticketId: ticketId,
        rca: rca,
        modem: modem,
        opName: opName,
        opPower: opPower,
        status: status
    });

    if (status === 'Unresolved') {
        showToast('Saved to Sheet. Automation skipped.', 'success');
        form.reset();
        return;
    }

    const command = `${ticketId} | ${rca} | ${modem}`;

    sendBtn.disabled = true;
    sendBtn.classList.add('loading');
    document.getElementById('btn-text').textContent = 'Processing...';

    try {
        const response = await fetch(`${TG_API}${RELAY_BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: CHANNEL_ID, text: command })
        });

        const result = await response.json();
        if (!result.ok) throw new Error(result.description);

        const startTime = Date.now();
        const outcome = await pollForResponse(ticketId, startTime);
        if (outcome.success) {
            showToast(`✅ ${outcome.message}`, 'success');
            saveToHistory(ticketId, modem);
            form.reset();
        } else {
            showToast(`❌ ${outcome.message}`, 'error');
        }
    } catch (err) {
        showToast(`⚠️ ${err.message}`, 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.classList.remove('loading');
        document.getElementById('btn-text').textContent = 'Submit Job';
    }
});

// Init
loadHistory();
</script>
</body>
</html>
